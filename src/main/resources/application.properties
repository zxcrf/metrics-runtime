# Quarkus Application Configuration
# 升级到 Quarkus 3.12.3 + JDK 21 虚拟线程 + DuckDB Parquet 优化

# Application Info
quarkus.application.name=dataos-metrics-runtime
quarkus.http.port=8080
quarkus.http.host=0.0.0.0

# Virtual Threads
quarkus.virtual-threads.enabled=true

# Native Image Optimization
# quarkus.native.additional-build-args=-J-Xmx8G,-march=native
quarkus.native.enable-https-url-handler=true
quarkus.native.monitoring=heapdump

# 索引依赖包以确保 CDI bean 被发现
quarkus.index-dependency.duckdb.group-id=org.duckdb
quarkus.index-dependency.duckdb.artifact-id=duckdb_jdbc
quarkus.index-dependency.sqlite.group-id=org.xerial
quarkus.index-dependency.sqlite.artifact-id=sqlite-jdbc
quarkus.index-dependency.minio.group-id=io.minio
quarkus.index-dependency.minio.artifact-id=minio
quarkus.index-dependency.caffeine.group-id=com.github.ben-manes.caffeine
quarkus.index-dependency.caffeine.artifact-id=caffeine

# Native Image 配置
quarkus.native.enable-all-security-services=true
quarkus.native.add-all-charsets=true
quarkus.native.resources.includes=**/*.parquet,**/*.properties,**/*.sql,**/*.json,libduckdb_java.so_linux_amd64,libduckdb_java.so_osx_universal,libduckdb_java.so_windows_amd64,libduckdb_java.so_linux_arm64

# DuckDB JNI 支持
  -J-Xmx8G,\
  -march=native,\
  -H:+AddAllCharsets,\
  --enable-url-protocols=http,\
  --enable-url-protocols=https,\
  --initialize-at-build-time=org.duckdb.DuckDBDriver,\
  --initialize-at-run-time=org.duckdb.DuckDBNative



# MetaDB (MySQL)
quarkus.datasource.metadb.db-kind=${DATAOS_METRICS_METADB_TYPE:mysql}
quarkus.datasource.metadb.jdbc.url=${DATAOS_METRICS_METADB_JDBC_URL:jdbc:mysql://127.0.0.1:3306/kpi_2025?useSSL=FALSE&characterEncoding=utf-8&allowPublicKeyRetrieval=true&allowMultiQueries=true}
quarkus.datasource.metadb.username=${DATAOS_METRICS_METADB_USERNAME:root}
quarkus.datasource.metadb.password=${DATAOS_METRICS_METADB_PASSWORD:root}
quarkus.datasource.metadb.jdbc.max-size=${DATAOS_METRICS_METADB_MAX_SIZE:50}
quarkus.datasource.metadb.jdbc.min-size=10
quarkus.datasource.metadb.jdbc.acquisition-timeout=5

# MetaDB Pool Optimization
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.preparedStatementCacheSize=500
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.preparedStatementCacheSqlLimit=2048
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.socketTimeout=60
quarkus.datasource.metadb.jdbc.validation-query-sql=SELECT 1
quarkus.datasource.metadb.jdbc.background-validation-interval=1M

# SQLite (保留配置，防止旧代码报错，但不主要使用)
quarkus.datasource.sqlite.db-kind=other
quarkus.datasource.sqlite.jdbc.driver=org.sqlite.JDBC
quarkus.datasource.sqlite.jdbc.url=jdbc:sqlite::memory:
quarkus.datasource.sqlite.jdbc.max-size=10

# DuckDB DataSource Configuration (核心引擎)
quarkus.datasource.duckdb.db-kind=other
quarkus.datasource.duckdb.jdbc.driver=org.duckdb.DuckDBDriver


# ==============================================================================
# 4C/8G 调优配置
# ==============================================================================
# 1. DuckDB 资源限制 (关键)
# threads=4: 限制 DuckDB 内部并行度不超过物理核数，避免抢占 HTTP 线程
# memory_limit=2.5GB: 严格限制 DuckDB 堆外内存，防止容器 OOM
quarkus.datasource.duckdb.jdbc.url=jdbc:duckdb:?threads=4&memory_limit=2.5GB
# 2. 数据库连接池 (限流阀)
# 不需要太大，DuckDB 处理快，积压的请求在虚拟线程里排队即可
# 设置为 16 (CPU * 4)，保证有足够的连接处理并发，但不会撑爆内存
quarkus.datasource.duckdb.jdbc.max-size=16
quarkus.datasource.duckdb.jdbc.min-size=4
quarkus.datasource.duckdb.jdbc.acquisition-timeout=5

# MinIO Configuration
minio.endpoint=${MINIO_ENDPOINT:http://127.0.0.1:9000}
minio.access-key=${MINIO_ACCESS_KEY:minioadmin}
minio.secret-key=${MINIO_SECRET_KEY:minioadmin}
minio.bucket.metrics=${MINIO_BUCKET:metrics-runtime}
minio.secure=false

# MinIO Client Pool Optimization
minio.pool.max-idle=500
minio.http.max-requests=500
minio.http.max-requests-per-host=100
# 保持连接更久一点，减少握手开销
minio.pool.keep-alive-minutes=5
minio.http.read-timeout-sec=5
minio.http.connect-timeout-sec=2

# Redis Configuration
quarkus.redis.hosts=redis://${REDIS_HOST:127.0.0.1}:${REDIS_PORT:6379}
quarkus.redis.password=${REDIS_PASSWORD:}
quarkus.redis.max-pool-size=${REDIS_MAX_POOL_SIZE:128}
quarkus.redis.max-pool-waiting=${REDIS_MAX_POOL_WAITING:2048}

# 根据内存调整，每条目约10-100KB
kpi.cache.max.size=1000
# Cache TTL
kpi.cache.ttl.minutes=${KPI_CACHE_TTL_MINUTES:30}

# Monitoring
quarkus.micrometer.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.binder.vertx.enabled=true

# Logging
quarkus.log.console.json.enabled=false

# Engine Config
metrics.engine.type=${DATAOS_METRICS_ENGINE:SQLite}
metrics.driver.plugin.dir=${DATAOS_METRICS_DRIVER_PLUGIN:plugin}
metrics.sqlite.storage.dir=${DATAOS_METRICS_SQLITE_STORAGE_DIR:/tmp/cache}