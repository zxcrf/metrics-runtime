# Quarkus Application Configuration
# 升级到 Quarkus 3.12.3 + JDK 21 虚拟线程 + DuckDB Parquet 优化

# Application Info
quarkus.application.name=dataos-metrics-runtime
quarkus.http.port=8080
quarkus.http.host=0.0.0.0

# Virtual Threads
quarkus.virtual-threads.enabled=true

# Native Image Optimization
quarkus.native.additional-build-args=-J-Xmx8G,-march=native
quarkus.native.enable-https-url-handler=true
quarkus.native.monitoring=heapdump

# MetaDB (MySQL)
quarkus.datasource.metadb.db-kind=${DATAOS_METRICS_METADB_TYPE:mysql}
quarkus.datasource.metadb.jdbc.url=${DATAOS_METRICS_METADB_JDBC_URL:jdbc:mysql://127.0.0.1:3306/kpi_2025?useSSL=FALSE&characterEncoding=utf-8&allowPublicKeyRetrieval=true&allowMultiQueries=true}
quarkus.datasource.metadb.username=${DATAOS_METRICS_METADB_USERNAME:root}
quarkus.datasource.metadb.password=${DATAOS_METRICS_METADB_PASSWORD:root}
quarkus.datasource.metadb.jdbc.max-size=${DATAOS_METRICS_METADB_MAX_SIZE:50}
quarkus.datasource.metadb.jdbc.min-size=10
quarkus.datasource.metadb.jdbc.acquisition-timeout=5

# MetaDB Pool Optimization
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.preparedStatementCacheSize=500
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.preparedStatementCacheSqlLimit=2048
%prod.quarkus.datasource.metadb.jdbc.additional-jdbc-properties.socketTimeout=60
quarkus.datasource.metadb.jdbc.validation-query-sql=SELECT 1
quarkus.datasource.metadb.jdbc.background-validation-interval=1M

# SQLite (保留配置，防止旧代码报错，但不主要使用)
quarkus.datasource.sqlite.db-kind=other
quarkus.datasource.sqlite.jdbc.driver=org.sqlite.JDBC
quarkus.datasource.sqlite.jdbc.url=jdbc:sqlite::memory:
quarkus.datasource.sqlite.jdbc.max-size=10

# DuckDB DataSource Configuration (核心引擎)
quarkus.datasource.duckdb.db-kind=other
quarkus.datasource.duckdb.jdbc.driver=org.duckdb.DuckDBDriver
# 关键优化：启用内存限制和并行线程
quarkus.datasource.duckdb.jdbc.url=jdbc:duckdb:?memory_limit=4GB&threads=8
# 连接池调整：DuckDB 嵌入式模式不需要太大的连接池，减少上下文切换
quarkus.datasource.duckdb.jdbc.max-size=32
quarkus.datasource.duckdb.jdbc.min-size=4

# MinIO Configuration
minio.endpoint=${MINIO_ENDPOINT:http://127.0.0.1:9000}
minio.access-key=${MINIO_ACCESS_KEY:minioadmin}
minio.secret-key=${MINIO_SECRET_KEY:minioadmin}
minio.bucket.metrics=${MINIO_BUCKET:metrics-runtime}
minio.secure=false

# MinIO Client Pool Optimization
minio.pool.max-idle=500
minio.pool.keep-alive-minutes=2
minio.http.max-requests=2000
minio.http.max-requests-per-host=500
minio.http.read-timeout-sec=5
minio.http.connect-timeout-sec=2

# Redis Configuration
quarkus.redis.hosts=redis://${REDIS_HOST:127.0.0.1}:${REDIS_PORT:6379}
quarkus.redis.password=${REDIS_PASSWORD:}
quarkus.redis.max-pool-size=${REDIS_MAX_POOL_SIZE:128}
quarkus.redis.max-pool-waiting=${REDIS_MAX_POOL_WAITING:2048}

# Cache TTL
kpi.cache.ttl.minutes=${KPI_CACHE_TTL_MINUTES:30}

# Monitoring
quarkus.micrometer.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.binder.vertx.enabled=true

# Logging
quarkus.log.console.json.enabled=false

# Engine Config
metrics.engine.type=${DATAOS_METRICS_ENGINE:SQLite}
metrics.driver.plugin.dir=${DATAOS_METRICS_DRIVER_PLUGIN:plugin}
metrics.sqlite.storage.dir=${DATAOS_METRICS_SQLITE_STORAGE_DIR:/tmp/cache}